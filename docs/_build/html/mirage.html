

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Mirage &mdash; Skyline 1.0.0-dev documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  

  
    <link rel="stylesheet" href="_static/skyline.styles.css" type="text/css" />
  

  
    <link rel="top" title="Skyline 1.0.0-dev documentation" href="index.html"/>
        <link rel="next" title="Boundary" href="boundary.html"/>
        <link rel="prev" title="Analyzer Optimizations" href="analyzer-optimizations.html"/> 

  
  <script src="_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="index.html" class="icon icon-home"> Skyline
          

          
          </a>

          
            
            
              <div class="version">
                1.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="requirements.html">Requirements</a></li>
<li class="toctree-l1"><a class="reference internal" href="getting-started.html">Getting started</a></li>
<li class="toctree-l1"><a class="reference internal" href="running-in-python-virtualenv.html">Running Skyline in a Python virtualenv</a></li>
<li class="toctree-l1"><a class="reference internal" href="installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="upgrading.html">Upgrading</a></li>
<li class="toctree-l1"><a class="reference internal" href="getting-data-into-skyline.html">Getting data into Skyline</a></li>
<li class="toctree-l1"><a class="reference internal" href="alert-testing.html">Alert testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="horizon.html">Horizon</a></li>
<li class="toctree-l1"><a class="reference internal" href="analyzer.html">Analyzer</a></li>
<li class="toctree-l1"><a class="reference internal" href="analyzer-optimizations.html">Analyzer Optimizations</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Mirage</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#what-mirage-can-and-cannot-do">What Mirage can and cannot do</a></li>
<li class="toctree-l2"><a class="reference internal" href="#setting-up-mirage">Setting up Mirage</a></li>
<li class="toctree-l2"><a class="reference internal" href="#what-mirage-does">What Mirage does</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="boundary.html">Boundary</a></li>
<li class="toctree-l1"><a class="reference internal" href="crucible.html">Crucible</a></li>
<li class="toctree-l1"><a class="reference internal" href="panorama.html">Panorama</a></li>
<li class="toctree-l1"><a class="reference internal" href="webapp.html">Webapp</a></li>
<li class="toctree-l1"><a class="reference internal" href="redis-integration.html">Redis integration</a></li>
<li class="toctree-l1"><a class="reference internal" href="skyline-and-friends.html">Skyline and friends</a></li>
<li class="toctree-l1"><a class="reference internal" href="logging.html">Logging</a></li>
<li class="toctree-l1"><a class="reference internal" href="tuning-tips.html">Tuning tips</a></li>
<li class="toctree-l1"><a class="reference internal" href="tuning-tips.html#smaller-deployments">Smaller deployments</a></li>
<li class="toctree-l1"><a class="reference internal" href="tuning-tips.html#reliability">Reliability</a></li>
<li class="toctree-l1"><a class="reference internal" href="monitoring-skyline.html">Monitoring Skyline</a></li>
<li class="toctree-l1"><a class="reference internal" href="debian-and-vagrant-installation-tips.html">Debian and Vagrant Installation Tips</a></li>
<li class="toctree-l1"><a class="reference internal" href="building-documentation.html">Building documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="releases.html">Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="whats-new.html">What&#8217;s new</a></li>
<li class="toctree-l1"><a class="reference internal" href="development/index.html">Development</a></li>
<li class="toctree-l1"><a class="reference internal" href="roadmap.html">Roadmap</a></li>
<li class="toctree-l1"><a class="reference internal" href="skyline.html">skyline package</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="index.html">Skyline</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          

 



<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="index.html">Docs</a> &raquo;</li>
      
    <li>Mirage</li>
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="_sources/mirage.txt" rel="nofollow"> View page source</a>
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="mirage">
<h1>Mirage<a class="headerlink" href="#mirage" title="Permalink to this headline">¶</a></h1>
<p>The Mirage service is responsible for analyzing selected timeseries at custom
time ranges when a timeseries seasonality does not fit within
<a class="reference internal" href="skyline.html#settings.FULL_DURATION" title="settings.FULL_DURATION"><code class="xref py py-mod docutils literal"><span class="pre">settings.FULL_DURATION</span></code></a>.</p>
<p>The Mirage aap allows for second order resolution analysis of metrics that
have a <code class="docutils literal"><span class="pre">SECOND_ORDER_RESOLUTION_HOURS</span></code> defined in their Analyzer alert tuple
<a class="reference internal" href="skyline.html#settings.ALERTS" title="settings.ALERTS"><code class="xref py py-mod docutils literal"><span class="pre">settings.ALERTS</span></code></a> setting.</p>
<p>Analyzer&#8217;s <a class="reference internal" href="skyline.html#settings.FULL_DURATION" title="settings.FULL_DURATION"><code class="xref py py-mod docutils literal"><span class="pre">settings.FULL_DURATION</span></code></a> somewhat limits Analyzer&#8217;s usefulness
for metrics that have a seasonality / periodicity that is greater than
<a class="reference internal" href="skyline.html#settings.FULL_DURATION" title="settings.FULL_DURATION"><code class="xref py py-mod docutils literal"><span class="pre">settings.FULL_DURATION</span></code></a>.  Increasing <a class="reference internal" href="skyline.html#settings.FULL_DURATION" title="settings.FULL_DURATION"><code class="xref py py-mod docutils literal"><span class="pre">settings.FULL_DURATION</span></code></a> to
anything above 24 hours (86400) is not necessarily realistic or useful, because
the greater the <a class="reference internal" href="skyline.html#settings.FULL_DURATION" title="settings.FULL_DURATION"><code class="xref py py-mod docutils literal"><span class="pre">settings.FULL_DURATION</span></code></a>, the greater memory required for
Redis and the longer Skyline analyzer will take to run.</p>
<p>Mirage uses the user-defined seasonality for a metric
(<code class="docutils literal"><span class="pre">SECOND_ORDER_RESOLUTION_HOURS</span></code>) and if Analyzer finds a metric to be
anomalous at <a class="reference internal" href="skyline.html#settings.FULL_DURATION" title="settings.FULL_DURATION"><code class="xref py py-mod docutils literal"><span class="pre">settings.FULL_DURATION</span></code></a> and the metric alert tuple has
<cite>SECOND_ORDER_RESOLUTION_HOURS</cite> and <a class="reference internal" href="skyline.html#settings.ENABLE_MIRAGE" title="settings.ENABLE_MIRAGE"><code class="xref py py-mod docutils literal"><span class="pre">settings.ENABLE_MIRAGE</span></code></a> is <code class="docutils literal"><span class="pre">True</span></code>,
Analyzer will push the metric variables to the Mirage check file for Mirage to
surface the metric&#8217;s timeseries at its defined seasonality, in real time from
Graphite in json format and then analyze the timeseries to determine if the
datapoint that triggered analyzer, is anomalous at the metric&#8217;s true
seasonality.</p>
<div class="section" id="what-mirage-can-and-cannot-do">
<h2>What Mirage can and cannot do<a class="headerlink" href="#what-mirage-can-and-cannot-do" title="Permalink to this headline">¶</a></h2>
<p>It is important to know that Mirage is not necessarily suited to make highly
variable less noisy e.g. spikey metrics.</p>
<p>Mirage is more useful on fairly constant rate metrics which contain known
or expected seasonalities.  For example take a metric such as
office.energy.consumation.per.hour,  this type of metric would most likely have
2 common seasonalities.</p>
<p>As an example we can use the <a class="reference external" href="https://www.gov.uk/government/publications/greening-government-and-transparency-commitments-real-time-energy-data">Department of Education</a>
Sanctuary Buildings energy consumption public <a class="reference external" href="https://www.gov.uk/government/uploads/system/uploads/attachment_data/file/476574/Real_time_energy_data_October.csv">data set</a>
to demonstrate how Mirage and Analyzer views are different.  The energy
consumption in an office building is a good example of a multi-seasonal data set.</p>
<ul class="simple">
<li>Office hour peaks</li>
<li>Out of hour troughs</li>
<li>Weekend troughs</li>
<li>Holidays</li>
<li>There could be summer and winter seasonality too</li>
</ul>
<p>For now let us just consider the daily and weekly seasonality.</p>
<p>(<a class="reference external" href=".//mirage-1.py">Source code</a>, <a class="reference external" href=".//mirage-1.png">png</a>, <a class="reference external" href=".//mirage-1.hires.png">hires.png</a>, <a class="reference external" href=".//mirage-1.pdf">pdf</a>)</p>
<div class="figure">
<img alt="_images/mirage-1.png" src="_images/mirage-1.png" />
</div>
<p><a class="reference external" href="_images/mirage-1.png">Fullsize image</a> for a clearer picture.</p>
<p>As we can see above, on a Saturday morning the energy consumption does not
increase as it normally does during the week days. Analyzer would probably find
the metric to be anomalous if <a class="reference internal" href="skyline.html#settings.ANALYZER_CRUCIBLE_ENABLED" title="settings.ANALYZER_CRUCIBLE_ENABLED"><code class="xref py py-mod docutils literal"><span class="pre">settings.ANALYZER_CRUCIBLE_ENABLED</span></code></a> was set
to 86400 (24 hours), Saturday morning would seem anomalous.</p>
<p>However, if the metric&#8217;s alert tuple was set up with a
<code class="docutils literal"><span class="pre">SECOND_ORDER_RESOLUTION_HOURS</span></code> of 168, Mirage would analyze the data point
against a week&#8217;s worth of data points and the Saturday and Sunday daytime data
points would have less probability of triggering as anomalous.  <em>The above
image is plotted as if the Mirage ``SECOND_ORDER_RESOLUTION_HOURS`` was set to
172 hours just so that the trailing edges can be seen.</em></p>
<p>Mirage is a &#8220;tuning&#8221; tool for seasonal metrics and it is important to understand
that Mirage is probably using aggregated data (unless your Graphite is not using
retentions and aggregating) and due to this Mirage will lose some resolution
resulting in it being less sensitive to anomalies than Analyzer is.</p>
</div>
<div class="section" id="setting-up-mirage">
<h2>Setting up Mirage<a class="headerlink" href="#setting-up-mirage" title="Permalink to this headline">¶</a></h2>
<p>By default Mirage is disabled, various Mirage options can be configured in the
<code class="docutils literal"><span class="pre">settings.py</span></code> file and Analyzer and Mirage can be configured as appropriate
for your environment.</p>
<p>Mirage requires some directories as per <code class="docutils literal"><span class="pre">settings.py</span></code> defines (these require
absolute path):</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>sudo mkdir -p <span class="nv">$MIRAGE_CHECK_PATH</span>
sudo mkdir -p <span class="nv">$MIRAGE_DATA_FOLDER</span>
</pre></div>
</div>
<p>Configure <code class="docutils literal"><span class="pre">settings.py</span></code> with some alert tuples that have the
<code class="docutils literal"><span class="pre">SECOND_ORDER_RESOLUTION_HOURS</span></code> defined, e.g.:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">ALERTS</span> <span class="o">=</span> <span class="p">(</span>
           <span class="p">(</span><span class="s2">&quot;skyline&quot;</span><span class="p">,</span> <span class="s2">&quot;smtp&quot;</span><span class="p">,</span> <span class="mi">1800</span><span class="p">),</span>
           <span class="p">(</span><span class="s2">&quot;stats_counts.http.rpm.publishers.*&quot;</span><span class="p">,</span> <span class="s2">&quot;smtp&quot;</span><span class="p">,</span> <span class="mi">300</span><span class="p">,</span> <span class="mi">168</span><span class="p">),</span>
<span class="p">)</span>
</pre></div>
</div>
<p>And ensure that <code class="docutils literal"><span class="pre">settings.py</span></code> has Mirage options enabled, specifically the
basic ones:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">ENABLE_MIRAGE</span> <span class="o">=</span> <span class="bp">True</span>
<span class="n">ENABLE_FULL_DURATION_ALERTS</span> <span class="o">=</span> <span class="bp">False</span>
<span class="n">MIRAGE_ENABLE_ALERTS</span> <span class="o">=</span> <span class="bp">True</span>
</pre></div>
</div>
<p>Start Mirage:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="nb">cd</span> skyline/bin
sudo ./mirage.d start
</pre></div>
</div>
<p>Mirage allows for testing of real time data and algorithms in parallel to
Analyzer allowing for comparisons of different timeseries and/or algorithms.
Mirage was inspired by Crucible and the desire to extend the temporal data pools
available to Analyzer in an attempt to handle seasonality better, reduce noise
and increase signal, specifically on seasonal metrics.</p>
<p>Mirage is rate limited to analyze 30 metrics per minute, this is by design and
desired. Surfacing data from Graphite and analyzing ~1000 data points in a
timeseries takes less than 1 second and is much less CPU intensive than
Analyzer in general, but it is probably sufficient to have 30 calls to Graphite
per minute.  If a large number of metrics went anomalous, even with Mirage
discarding <a class="reference internal" href="skyline.html#settings.MIRAGE_STALE_SECONDS" title="settings.MIRAGE_STALE_SECONDS"><code class="xref py py-mod docutils literal"><span class="pre">settings.MIRAGE_STALE_SECONDS</span></code></a> checks due to processing limit,
signals would still be sent.</p>
</div>
<div class="section" id="what-mirage-does">
<h2>What Mirage does<a class="headerlink" href="#what-mirage-does" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>Mirage watches for added check files.</li>
<li>When a check is found, Mirage determines what the configured
<code class="docutils literal"><span class="pre">SECOND_ORDER_RESOLUTION_HOURS</span></code> is for the metric from the tuple in
<a class="reference internal" href="skyline.html#settings.ALERTS" title="settings.ALERTS"><code class="xref py py-mod docutils literal"><span class="pre">settings.ALERTS</span></code></a></li>
<li>Mirage queries graphite to surface the json data for the metric timeseries at
<code class="docutils literal"><span class="pre">SECOND_ORDER_RESOLUTION_HOURS</span></code>.</li>
<li>Mirage then analyses the retrieved metric timeseries against the configured
<a class="reference internal" href="skyline.html#settings.MIRAGE_ALGORITHMS" title="settings.MIRAGE_ALGORITHMS"><code class="xref py py-mod docutils literal"><span class="pre">settings.MIRAGE_ALGORITHMS</span></code></a>.</li>
<li>If the metric is anomalous over <code class="docutils literal"><span class="pre">SECOND_ORDER_RESOLUTION_HOURS</span></code> then alerts
via the configured alerters for the matching metric <code class="xref py py-mod docutils literal"><span class="pre">settings.ALERT</span></code>
tuple and sets the metric alert key for <code class="docutils literal"><span class="pre">EXPIRATION_TIME</span></code> seconds.</li>
</ul>
</div>
</div>


           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="boundary.html" class="btn btn-neutral float-right" title="Boundary" accesskey="n">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="analyzer-optimizations.html" class="btn btn-neutral" title="Analyzer Optimizations" accesskey="p"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2013-2014, Etsy Inc; 2015, Abe Stanway; 2015-2016, Gary Wilson.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'./',
            VERSION:'1.0.0-dev',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="_static/jquery.js"></script>
      <script type="text/javascript" src="_static/underscore.js"></script>
      <script type="text/javascript" src="_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>