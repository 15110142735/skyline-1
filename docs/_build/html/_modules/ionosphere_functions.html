

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>ionosphere_functions &mdash; Skyline 1.1.7-beta documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  

  
    <link rel="stylesheet" href="../_static/skyline.styles.css" type="text/css" />
  

  
        <link rel="index" title="Index"
              href="../genindex.html"/>
        <link rel="search" title="Search" href="../search.html"/>
    <link rel="top" title="Skyline 1.1.7-beta documentation" href="../index.html"/>
        <link rel="up" title="Module code" href="index.html"/> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> Skyline
          

          
          </a>

          
            
            
              <div class="version">
                1.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul>
<li class="toctree-l1"><a class="reference internal" href="../overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../requirements.html">Requirements</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting-started.html">Getting started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../running-in-python-virtualenv.html">Running Skyline in a Python virtualenv</a></li>
<li class="toctree-l1"><a class="reference internal" href="../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../upgrading/index.html">Upgrading</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting-data-into-skyline.html">Getting data into Skyline</a></li>
<li class="toctree-l1"><a class="reference internal" href="../alert-testing.html">Alert testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../monotonic-metrics.html">Strictly increasing monotonicity</a></li>
<li class="toctree-l1"><a class="reference internal" href="../horizon.html">Horizon</a></li>
<li class="toctree-l1"><a class="reference internal" href="../analyzer.html">Analyzer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../analyzer-optimizations.html">Analyzer Optimizations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mirage.html">Mirage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../boundary.html">Boundary</a></li>
<li class="toctree-l1"><a class="reference internal" href="../crucible.html">Crucible</a></li>
<li class="toctree-l1"><a class="reference internal" href="../panorama.html">Panorama</a></li>
<li class="toctree-l1"><a class="reference internal" href="../webapp.html">Webapp</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ionosphere.html">Ionosphere</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tsfresh.html">tsfresh</a></li>
<li class="toctree-l1"><a class="reference internal" href="../redis-integration.html">Redis integration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../skyline-and-friends.html">Skyline and friends</a></li>
<li class="toctree-l1"><a class="reference internal" href="../logging.html">Logging</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tuning-tips.html">Tuning tips</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tuning-tips.html#smaller-deployments">Smaller deployments</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tuning-tips.html#reliability">Reliability</a></li>
<li class="toctree-l1"><a class="reference internal" href="../monitoring-skyline.html">Monitoring Skyline</a></li>
<li class="toctree-l1"><a class="reference internal" href="../debian-and-vagrant-installation-tips.html">Debian and Vagrant Installation Tips</a></li>
<li class="toctree-l1"><a class="reference internal" href="../releases.html">Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../whats-new.html">What&#8217;s new</a></li>
<li class="toctree-l1"><a class="reference internal" href="../development/index.html">Development</a></li>
<li class="toctree-l1"><a class="reference internal" href="../roadmap.html">Roadmap</a></li>
<li class="toctree-l1"><a class="reference internal" href="../skyline.html">skyline package</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../index.html">Skyline</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          





<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html">Docs</a> &raquo;</li>
      
          <li><a href="index.html">Module code</a> &raquo;</li>
      
    <li>ionosphere_functions</li>
      <li class="wy-breadcrumbs-aside">
        
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for ionosphere_functions</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">division</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">from</span> <span class="nn">os</span> <span class="k">import</span> <span class="n">path</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="c1"># import string</span>
<span class="c1"># import operator</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">csv</span>
<span class="c1"># import datetime</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">from</span> <span class="nn">ast</span> <span class="k">import</span> <span class="n">literal_eval</span>

<span class="kn">import</span> <span class="nn">traceback</span>
<span class="kn">from</span> <span class="nn">redis</span> <span class="k">import</span> <span class="n">StrictRedis</span>

<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">create_engine</span><span class="p">,</span> <span class="n">Column</span><span class="p">,</span> <span class="n">Table</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">String</span><span class="p">,</span> <span class="n">MetaData</span><span class="p">,</span> <span class="n">DateTime</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.dialects.mysql</span> <span class="k">import</span> <span class="n">DOUBLE</span><span class="p">,</span> <span class="n">TINYINT</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.sql</span> <span class="k">import</span> <span class="n">select</span>
<span class="c1"># import json</span>
<span class="kn">from</span> <span class="nn">tsfresh</span> <span class="k">import</span> <span class="n">__version__</span> <span class="k">as</span> <span class="n">tsfresh_version</span>

<span class="kn">import</span> <span class="nn">settings</span>
<span class="kn">import</span> <span class="nn">skyline_version</span>
<span class="kn">from</span> <span class="nn">skyline_functions</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">RepresentsInt</span><span class="p">,</span> <span class="n">mkdir_p</span><span class="p">,</span> <span class="n">write_data_to_file</span><span class="p">,</span> <span class="n">get_graphite_metric</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">tsfresh_feature_names</span> <span class="k">import</span> <span class="n">TSFRESH_FEATURES</span>

<span class="kn">from</span> <span class="nn">database</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">get_engine</span><span class="p">,</span> <span class="n">ionosphere_table_meta</span><span class="p">,</span> <span class="n">metrics_table_meta</span><span class="p">,</span>
    <span class="n">ionosphere_matched_table_meta</span><span class="p">)</span>

<span class="n">skyline_version</span> <span class="o">=</span> <span class="n">skyline_version</span><span class="o">.</span><span class="n">__absolute_version__</span>

<span class="k">try</span><span class="p">:</span>
    <span class="n">full_duration_seconds</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">FULL_DURATION</span><span class="p">)</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">full_duration_seconds</span> <span class="o">=</span> <span class="mi">86400</span>

<span class="n">full_duration_in_hours</span> <span class="o">=</span> <span class="n">full_duration_seconds</span> <span class="o">/</span> <span class="mi">60</span> <span class="o">/</span> <span class="mi">60</span>

<span class="c1"># @created 20170114 - Feature #1854: Ionosphere learn</span>
<span class="c1"># This function was moved in its entirety from webapp/ionosphere_backend.py</span>
<span class="c1"># so as to decouple the creation of features profiles from the webapp as</span>
<span class="c1"># ionosphere/learn.py now requires the ability to create features profiles to.</span>
<span class="c1"># The only things modified were that current_skyline_app, current_logger and</span>
<span class="c1"># generations parameters were added the function:</span>
<span class="c1"># ionosphere_job, parent_id, generation</span>


<div class="viewcode-block" id="fp_create_get_an_engine"><a class="viewcode-back" href="../skyline.html#ionosphere_functions.fp_create_get_an_engine">[docs]</a><span class="k">def</span> <span class="nf">fp_create_get_an_engine</span><span class="p">(</span><span class="n">current_skyline_app</span><span class="p">):</span>

    <span class="n">current_skyline_app_logger</span> <span class="o">=</span> <span class="n">current_skyline_app</span> <span class="o">+</span> <span class="s1">&#39;Log&#39;</span>
    <span class="n">current_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">current_skyline_app_logger</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">engine</span><span class="p">,</span> <span class="n">fail_msg</span><span class="p">,</span> <span class="n">trace</span> <span class="o">=</span> <span class="n">get_engine</span><span class="p">(</span><span class="n">current_skyline_app</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">engine</span><span class="p">,</span> <span class="n">fail_msg</span><span class="p">,</span> <span class="n">trace</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
        <span class="n">current_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">trace</span><span class="p">)</span>
        <span class="n">fail_msg</span> <span class="o">=</span> <span class="s1">&#39;error :: fp_create_get_an_engine :: failed to get MySQL engine&#39;</span>
        <span class="n">current_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">fail_msg</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="n">fail_msg</span><span class="p">,</span> <span class="n">trace</span></div>


<div class="viewcode-block" id="fp_create_engine_disposal"><a class="viewcode-back" href="../skyline.html#ionosphere_functions.fp_create_engine_disposal">[docs]</a><span class="k">def</span> <span class="nf">fp_create_engine_disposal</span><span class="p">(</span><span class="n">current_skyline_app</span><span class="p">,</span> <span class="n">engine</span><span class="p">):</span>

    <span class="n">current_skyline_app_logger</span> <span class="o">=</span> <span class="n">current_skyline_app</span> <span class="o">+</span> <span class="s1">&#39;Log&#39;</span>
    <span class="n">current_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">current_skyline_app_logger</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">engine</span><span class="p">:</span>
        <span class="n">current_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;fp_create_engine_disposal :: calling engine.dispose()&#39;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">engine</span><span class="o">.</span><span class="n">dispose</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">current_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">current_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: fp_create_engine_disposal :: calling engine.dispose()&#39;</span><span class="p">)</span>
    <span class="k">return</span></div>


<span class="c1"># @added 20170115 - Feature #1854: Ionosphere learn - generations</span>
<span class="c1"># Added determination of the learn related variables so that Panorama,</span>
<span class="c1"># webapp/ionosphere and learn can access this function to determine what the</span>
<span class="c1"># default IONOSPHERE_LEARN_DEFAULT_ or if a namespace has specific values in</span>
<span class="c1"># settings.IONOSPHERE_LEARN_NAMESPACE_CONFIG</span>

<span class="c1"># learn_full_duration_days, learn_valid_ts_older_than,</span>
<span class="c1"># max_generations and max_percent_diff_from_origin value to the</span>
<span class="c1"># insert statement if the table is the metrics table.</span>

<span class="c1"># Set the learn generations variables with the IONOSPHERE_LEARN_DEFAULT_ and any</span>
<span class="c1"># settings.IONOSPHERE_LEARN_NAMESPACE_CONFIG values.  These will later be</span>
<span class="c1"># overridden by any database values determined for the specific metric if</span>
<span class="c1"># they exist.</span>
<div class="viewcode-block" id="get_ionosphere_learn_details"><a class="viewcode-back" href="../skyline.html#ionosphere_functions.get_ionosphere_learn_details">[docs]</a><span class="k">def</span> <span class="nf">get_ionosphere_learn_details</span><span class="p">(</span><span class="n">current_skyline_app</span><span class="p">,</span> <span class="n">base_name</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Determines what the default ``IONOSPHERE_LEARN_DEFAULT_`` values and what the</span>
<span class="sd">    specific override values are if the metric matches a pattern defined in</span>
<span class="sd">    :mod:`settings.IONOSPHERE_LEARN_NAMESPACE_CONFIG`. This is used in Panorama,</span>
<span class="sd">    webapp/ionosphere_backend</span>

<span class="sd">    :param current_skyline_app: the Skyline app name calling the function</span>
<span class="sd">    :param base_name: thee base_name of the metric</span>
<span class="sd">    :type current_skyline_app: str</span>
<span class="sd">    :type base_name: str</span>
<span class="sd">    :return: tuple</span>
<span class="sd">    :return: (use_full_duration, valid_learning_duration, use_full_duration_days, max_generations, max_percent_diff_from_origin)</span>
<span class="sd">    :rtype: (int, int, int, int, float)</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">current_skyline_app_logger</span> <span class="o">=</span> <span class="n">current_skyline_app</span> <span class="o">+</span> <span class="s1">&#39;Log&#39;</span>
    <span class="n">current_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">current_skyline_app_logger</span><span class="p">)</span>

    <span class="n">use_full_duration</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">valid_learning_duration</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">use_full_duration_days</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">max_generations</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">max_percent_diff_from_origin</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">use_full_duration</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">IONOSPHERE_LEARN_DEFAULT_FULL_DURATION_DAYS</span> <span class="o">*</span> <span class="mi">86400</span><span class="p">)</span>
        <span class="n">valid_learning_duration</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">IONOSPHERE_LEARN_DEFAULT_VALID_TIMESERIES_OLDER_THAN_SECONDS</span><span class="p">)</span>
        <span class="n">use_full_duration_days</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">IONOSPHERE_LEARN_DEFAULT_FULL_DURATION_DAYS</span><span class="p">)</span>
        <span class="n">max_generations</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">IONOSPHERE_LEARN_DEFAULT_MAX_GENERATIONS</span><span class="p">)</span>
        <span class="n">max_percent_diff_from_origin</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">IONOSPHERE_LEARN_DEFAULT_MAX_PERCENT_DIFF_FROM_ORIGIN</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">namespace_config</span> <span class="ow">in</span> <span class="n">settings</span><span class="o">.</span><span class="n">IONOSPHERE_LEARN_NAMESPACE_CONFIG</span><span class="p">:</span>
            <span class="n">NAMESPACE_MATCH_PATTERN</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">namespace_config</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">METRIC_PATTERN</span> <span class="o">=</span> <span class="n">base_name</span>
            <span class="n">pattern_match</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Match by regex</span>
                <span class="n">namespace_match_pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">NAMESPACE_MATCH_PATTERN</span><span class="p">)</span>
                <span class="n">pattern_match</span> <span class="o">=</span> <span class="n">namespace_match_pattern</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">base_name</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">pattern_match</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">use_full_duration_days</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">namespace_config</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                        <span class="n">use_full_duration</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">namespace_config</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="mi">86400</span>
                        <span class="n">valid_learning_duration</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">namespace_config</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                        <span class="n">max_generations</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">namespace_config</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
                        <span class="n">max_percent_diff_from_origin</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">namespace_config</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
                        <span class="n">current_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;get_ionosphere_learn_details :: </span><span class="si">%s</span><span class="s1"> matches </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">base_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">namespace_config</span><span class="p">)))</span>
                        <span class="k">break</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">pattern_match</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">pattern_match</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">pattern_match</span><span class="p">:</span>
                <span class="c1"># Match by substring</span>
                <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">namespace_config</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="ow">in</span> <span class="n">base_name</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">use_full_duration_days</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">namespace_config</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                        <span class="n">use_full_duration</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">namespace_config</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="mi">86400</span>
                        <span class="n">valid_learning_duration</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">namespace_config</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                        <span class="n">max_generations</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">namespace_config</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
                        <span class="n">max_percent_diff_from_origin</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">namespace_config</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
                        <span class="n">current_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;get_ionosphere_learn_details :: </span><span class="si">%s</span><span class="s1"> matches </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">base_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">namespace_config</span><span class="p">)))</span>
                        <span class="k">break</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">pattern_match</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">pattern_match</span><span class="p">:</span>
                <span class="n">current_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;get_ionosphere_learn_details :: no specific namespace matches found, using default settings&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">current_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;get_ionosphere_learn_details :: found namespace config match settings&#39;</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">current_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
        <span class="n">current_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: get_ionosphere_learn_details :: failed to check namespace config settings matches&#39;</span><span class="p">)</span>

    <span class="n">current_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;get_ionosphere_learn_details :: use_full_duration_days       :: </span><span class="si">%s</span><span class="s1"> days&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">use_full_duration_days</span><span class="p">)))</span>
    <span class="n">current_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;get_ionosphere_learn_details :: use_full_duration            :: </span><span class="si">%s</span><span class="s1"> seconds&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">use_full_duration</span><span class="p">)))</span>
    <span class="n">current_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;get_ionosphere_learn_details :: valid_learning_duration      :: </span><span class="si">%s</span><span class="s1"> seconds&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">valid_learning_duration</span><span class="p">)))</span>
    <span class="n">current_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;get_ionosphere_learn_details :: max_generations              :: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">max_generations</span><span class="p">)))</span>
    <span class="n">current_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;get_ionosphere_learn_details :: max_percent_diff_from_origin :: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">max_percent_diff_from_origin</span><span class="p">)))</span>

    <span class="k">return</span> <span class="n">use_full_duration</span><span class="p">,</span> <span class="n">valid_learning_duration</span><span class="p">,</span> <span class="n">use_full_duration_days</span><span class="p">,</span> <span class="n">max_generations</span><span class="p">,</span> <span class="n">max_percent_diff_from_origin</span></div>


<div class="viewcode-block" id="create_features_profile"><a class="viewcode-back" href="../skyline.html#ionosphere_functions.create_features_profile">[docs]</a><span class="k">def</span> <span class="nf">create_features_profile</span><span class="p">(</span><span class="n">current_skyline_app</span><span class="p">,</span> <span class="n">requested_timestamp</span><span class="p">,</span> <span class="n">data_for_metric</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">ionosphere_job</span><span class="p">,</span> <span class="n">fp_parent_id</span><span class="p">,</span> <span class="n">fp_generation</span><span class="p">,</span> <span class="n">fp_learn</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Add a features_profile to the Skyline ionosphere database table.</span>

<span class="sd">    :param current_skyline_app: Skyline app name</span>
<span class="sd">    :param requested_timestamp: The timestamp of the dir that the features</span>
<span class="sd">        profile data is in</span>
<span class="sd">    :param data_for_metric: The base_name of the metric</span>
<span class="sd">    :param context: The context of the caller</span>
<span class="sd">    :param ionosphere_job: The ionosphere_job name related to creation request</span>
<span class="sd">        valid jobs are ``learn_fp_human``, ``learn_fp_generation``,</span>
<span class="sd">        ``learn_fp_learnt`` and ``learn_fp_automatic``.</span>
<span class="sd">    :param fp_parent_id: The id of the parent features profile that this was</span>
<span class="sd">        learnt from, 0 being an original human generated features profile</span>
<span class="sd">    :param fp_generation: The number of generations away for the original</span>
<span class="sd">        human generated features profile, 0 being an original human generated</span>
<span class="sd">        features profile.</span>
<span class="sd">    :param fp_learn: Whether Ionosphere should learn at use_full_duration_days</span>
<span class="sd">    :type current_skyline_app: str</span>
<span class="sd">    :type requested_timestamp: int</span>
<span class="sd">    :type data_for_metric: str</span>
<span class="sd">    :type context: str</span>
<span class="sd">    :type ionosphere_job: str</span>
<span class="sd">    :type fp_parent_id: int</span>
<span class="sd">    :type fp_generation: int</span>
<span class="sd">    :type fp_learn: boolean</span>
<span class="sd">    :return: fp_id, fp_in_successful, fp_exists, fail_msg, traceback_format_exc</span>
<span class="sd">    :rtype: str, boolean, boolean, str, str</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">current_skyline_app_logger</span> <span class="o">=</span> <span class="n">current_skyline_app</span> <span class="o">+</span> <span class="s1">&#39;Log&#39;</span>
    <span class="n">current_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">current_skyline_app_logger</span><span class="p">)</span>

    <span class="n">base_name</span> <span class="o">=</span> <span class="n">data_for_metric</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">FULL_NAMESPACE</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">context</span> <span class="o">==</span> <span class="s1">&#39;training_data&#39;</span><span class="p">:</span>
        <span class="n">log_context</span> <span class="o">=</span> <span class="s1">&#39;training data&#39;</span>
        <span class="n">ionosphere_learn_job</span> <span class="o">=</span> <span class="s1">&#39;learn_fp_human&#39;</span>
    <span class="k">if</span> <span class="n">context</span> <span class="o">==</span> <span class="s1">&#39;features_profiles&#39;</span><span class="p">:</span>
        <span class="n">log_context</span> <span class="o">=</span> <span class="s1">&#39;features profile data&#39;</span>

    <span class="c1"># @added 20170113 - Feature #1854: Ionosphere learn</span>
    <span class="k">if</span> <span class="n">context</span> <span class="o">==</span> <span class="s1">&#39;ionosphere_learn&#39;</span><span class="p">:</span>
        <span class="n">log_context</span> <span class="o">=</span> <span class="s1">&#39;learn&#39;</span>

    <span class="n">current_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;create_features_profile :: </span><span class="si">%s</span><span class="s1"> :: requested for </span><span class="si">%s</span><span class="s1"> at </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
        <span class="n">context</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">base_name</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">requested_timestamp</span><span class="p">)))</span>

    <span class="n">metric_timeseries_dir</span> <span class="o">=</span> <span class="n">base_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">context</span> <span class="o">==</span> <span class="s1">&#39;training_data&#39;</span><span class="p">:</span>
        <span class="n">metric_training_data_dir</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">settings</span><span class="o">.</span><span class="n">IONOSPHERE_DATA_FOLDER</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">requested_timestamp</span><span class="p">),</span>
            <span class="n">metric_timeseries_dir</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">context</span> <span class="o">==</span> <span class="s1">&#39;features_profiles&#39;</span><span class="p">:</span>
        <span class="n">metric_training_data_dir</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">settings</span><span class="o">.</span><span class="n">IONOSPHERE_PROFILES_FOLDER</span><span class="p">,</span> <span class="n">metric_timeseries_dir</span><span class="p">,</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">requested_timestamp</span><span class="p">))</span>

    <span class="c1"># @added 20170113 - Feature #1854: Ionosphere learn</span>
    <span class="k">if</span> <span class="n">context</span> <span class="o">==</span> <span class="s1">&#39;ionosphere_learn&#39;</span><span class="p">:</span>
        <span class="c1"># @modified 20170116 - Feature #1854: Ionosphere learn</span>
        <span class="c1"># Allowing ionosphere_learn to create a features profile for a training</span>
        <span class="c1"># data set that it has learnt is not anomalous</span>
        <span class="k">if</span> <span class="n">ionosphere_job</span> <span class="o">!=</span> <span class="s1">&#39;learn_fp_automatic&#39;</span><span class="p">:</span>
            <span class="n">metric_training_data_dir</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">settings</span><span class="o">.</span><span class="n">IONOSPHERE_LEARN_FOLDER</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">requested_timestamp</span><span class="p">),</span>
                <span class="n">metric_timeseries_dir</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">metric_training_data_dir</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">settings</span><span class="o">.</span><span class="n">IONOSPHERE_DATA_FOLDER</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">requested_timestamp</span><span class="p">),</span>
                <span class="n">metric_timeseries_dir</span><span class="p">)</span>

    <span class="n">features_file</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">.tsfresh.input.csv.features.transposed.csv&#39;</span> <span class="o">%</span> <span class="p">(</span>
        <span class="n">metric_training_data_dir</span><span class="p">,</span> <span class="n">base_name</span><span class="p">)</span>

    <span class="n">features_profile_dir</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
        <span class="n">settings</span><span class="o">.</span><span class="n">IONOSPHERE_PROFILES_FOLDER</span><span class="p">,</span> <span class="n">metric_timeseries_dir</span><span class="p">)</span>

    <span class="n">ts_features_profile_dir</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
        <span class="n">settings</span><span class="o">.</span><span class="n">IONOSPHERE_PROFILES_FOLDER</span><span class="p">,</span> <span class="n">metric_timeseries_dir</span><span class="p">,</span>
        <span class="nb">str</span><span class="p">(</span><span class="n">requested_timestamp</span><span class="p">))</span>

    <span class="n">features_profile_created_file</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">.fp.created.txt&#39;</span> <span class="o">%</span> <span class="p">(</span>
        <span class="n">metric_training_data_dir</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">requested_timestamp</span><span class="p">),</span> <span class="n">base_name</span><span class="p">)</span>

    <span class="n">features_profile_details_file</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">.fp.details.txt&#39;</span> <span class="o">%</span> <span class="p">(</span>
        <span class="n">metric_training_data_dir</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">requested_timestamp</span><span class="p">),</span> <span class="n">base_name</span><span class="p">)</span>

    <span class="n">anomaly_check_file</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">.txt&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">metric_training_data_dir</span><span class="p">,</span> <span class="n">base_name</span><span class="p">)</span>

    <span class="n">trace</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span>
    <span class="n">fail_msg</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span>
    <span class="n">new_fp_id</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">calculated_with_tsfresh</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">calculated_time</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">fcount</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">fsum</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="c1"># @added 20170104 - Feature #1842: Ionosphere - Graphite now graphs</span>
    <span class="c1"># Added the ts_full_duration parameter so that the appropriate graphs can be</span>
    <span class="c1"># embedded for the user in the training data page</span>
    <span class="n">ts_full_duration</span> <span class="o">=</span> <span class="s1">&#39;0&#39;</span>

    <span class="k">if</span> <span class="n">context</span> <span class="o">==</span> <span class="s1">&#39;ionosphere_learn&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">features_profile_details_file</span><span class="p">):</span>
            <span class="n">current_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: create_features_profile :: no features_profile_details_file - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">features_profile_details_file</span><span class="p">)</span>
            <span class="k">return</span> <span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">fail_msg</span><span class="p">,</span> <span class="n">trace</span>

    <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">features_profile_details_file</span><span class="p">):</span>
        <span class="n">current_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;create_features_profile :: getting features profile details from from - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">features_profile_details_file</span><span class="p">)</span>
        <span class="c1"># Read the details file</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">features_profile_details_file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">fp_details_str</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">fp_details</span> <span class="o">=</span> <span class="n">literal_eval</span><span class="p">(</span><span class="n">fp_details_str</span><span class="p">)</span>
        <span class="n">calculated_with_tsfresh</span> <span class="o">=</span> <span class="n">fp_details</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">calculated_time</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">fp_details</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">fcount</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">fp_details</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
        <span class="n">fsum</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">fp_details</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ts_full_duration</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">fp_details</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">current_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: create_features_profile :: could not determine the full duration from - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">features_profile_details_file</span><span class="p">)</span>
            <span class="n">ts_full_duration</span> <span class="o">=</span> <span class="s1">&#39;0&#39;</span>

        <span class="k">if</span> <span class="n">context</span> <span class="o">!=</span> <span class="s1">&#39;ionosphere_learn&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ts_full_duration</span> <span class="o">==</span> <span class="s1">&#39;0&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">anomaly_check_file</span><span class="p">):</span>
                    <span class="n">current_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;create_features_profile :: determining the full duration from anomaly_check_file - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">anomaly_check_file</span><span class="p">)</span>
                    <span class="c1"># Read the details file</span>
                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">anomaly_check_file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                        <span class="n">anomaly_details</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
                        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">anomaly_details</span><span class="p">):</span>
                            <span class="k">if</span> <span class="s1">&#39;full_duration&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                                <span class="n">_ts_full_duration</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">line</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
                                <span class="n">full_duration_array</span> <span class="o">=</span> <span class="n">literal_eval</span><span class="p">(</span><span class="n">_ts_full_duration</span><span class="p">)</span>
                                <span class="n">ts_full_duration</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">full_duration_array</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
                                <span class="n">current_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;create_features_profile :: determined the full duration as - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">ts_full_duration</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">features_profile_created_file</span><span class="p">):</span>
        <span class="c1"># Read the created file</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">features_profile_created_file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">fp_created_str</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">fp_created</span> <span class="o">=</span> <span class="n">literal_eval</span><span class="p">(</span><span class="n">fp_created_str</span><span class="p">)</span>
        <span class="n">new_fp_id</span> <span class="o">=</span> <span class="n">fp_created</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">new_fp_id</span><span class="p">),</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="n">fail_msg</span><span class="p">,</span> <span class="n">trace</span>

    <span class="c1"># Have data</span>
    <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">features_file</span><span class="p">):</span>
        <span class="n">current_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;create_features_profile :: features_file exists: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">features_file</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
        <span class="n">current_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">trace</span><span class="p">)</span>
        <span class="n">fail_msg</span> <span class="o">=</span> <span class="s1">&#39;error :: create_features_profile :: features_file does not exist: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">features_file</span>
        <span class="n">current_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">fail_msg</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">context</span> <span class="o">==</span> <span class="s1">&#39;training&#39;</span> <span class="ow">or</span> <span class="n">context</span> <span class="o">==</span> <span class="s1">&#39;features_profile&#39;</span><span class="p">:</span>
            <span class="c1"># Raise to webbapp I believe to provide traceback to user in UI</span>
            <span class="k">raise</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">fail_msg</span><span class="p">,</span> <span class="n">trace</span>

    <span class="n">features_data</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">features_file</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fr</span><span class="p">:</span>
        <span class="n">reader</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span><span class="n">fr</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">reader</span><span class="p">):</span>
            <span class="n">feature_name_item</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">fname_id</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">f_value</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">feature_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">feature_name_item</span> <span class="o">=</span> <span class="nb">filter</span><span class="p">(</span>
                <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">feature_name</span><span class="p">,</span> <span class="n">TSFRESH_FEATURES</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">feature_name_item</span><span class="p">:</span>
                <span class="n">feature_name_id</span> <span class="o">=</span> <span class="n">feature_name_item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">feature_name_item</span><span class="p">:</span>
                <span class="n">feature_name_list</span> <span class="o">=</span> <span class="n">feature_name_item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">fname_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">feature_name_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">f_value</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">fname_id</span> <span class="ow">and</span> <span class="n">f_value</span><span class="p">:</span>
                <span class="n">features_data</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">fname_id</span><span class="p">,</span> <span class="n">f_value</span><span class="p">])</span>

    <span class="c1"># @added 20170113 - Feature #1854: Ionosphere learn - generations</span>
    <span class="c1"># Set the learn generations variables with the IONOSPHERE_LEARN_DEFAULT_ and any</span>
    <span class="c1"># settings.IONOSPHERE_LEARN_NAMESPACE_CONFIG values.  These will later be</span>
    <span class="c1"># overridden by any database values determined for the specific metric if</span>
    <span class="c1"># they exist.</span>
    <span class="c1"># Set defaults</span>
    <span class="n">use_full_duration_days</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">IONOSPHERE_LEARN_DEFAULT_FULL_DURATION_DAYS</span><span class="p">)</span>
    <span class="n">valid_learning_duration</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">IONOSPHERE_LEARN_DEFAULT_VALID_TIMESERIES_OLDER_THAN_SECONDS</span><span class="p">)</span>
    <span class="n">max_generations</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">IONOSPHERE_LEARN_DEFAULT_MAX_GENERATIONS</span><span class="p">)</span>
    <span class="n">max_percent_diff_from_origin</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">IONOSPHERE_LEARN_DEFAULT_MAX_PERCENT_DIFF_FROM_ORIGIN</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">use_full_duration</span><span class="p">,</span> <span class="n">valid_learning_duration</span><span class="p">,</span> <span class="n">use_full_duration_days</span><span class="p">,</span> <span class="n">max_generations</span><span class="p">,</span> <span class="n">max_percent_diff_from_origin</span> <span class="o">=</span> <span class="n">get_ionosphere_learn_details</span><span class="p">(</span><span class="n">current_skyline_app</span><span class="p">,</span> <span class="n">base_name</span><span class="p">)</span>
        <span class="n">learn_full_duration_days</span> <span class="o">=</span> <span class="n">use_full_duration_days</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">current_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
        <span class="n">current_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: create_features_profile :: failed to get_ionosphere_learn_details&#39;</span><span class="p">)</span>

    <span class="n">current_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;create_features_profile :: learn_full_duration_days     :: </span><span class="si">%s</span><span class="s1"> days&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">learn_full_duration_days</span><span class="p">)))</span>
    <span class="n">current_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;create_features_profile :: valid_learning_duration      :: </span><span class="si">%s</span><span class="s1"> seconds&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">valid_learning_duration</span><span class="p">)))</span>
    <span class="n">current_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;create_features_profile :: max_generations              :: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">max_generations</span><span class="p">)))</span>
    <span class="n">current_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;create_features_profile :: max_percent_diff_from_origin :: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">max_percent_diff_from_origin</span><span class="p">)))</span>

    <span class="n">current_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;create_features_profile :: getting MySQL engine&#39;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">engine</span><span class="p">,</span> <span class="n">fail_msg</span><span class="p">,</span> <span class="n">trace</span> <span class="o">=</span> <span class="n">fp_create_get_an_engine</span><span class="p">(</span><span class="n">current_skyline_app</span><span class="p">)</span>
        <span class="n">current_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">fail_msg</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
        <span class="n">current_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">trace</span><span class="p">)</span>
        <span class="n">fail_msg</span> <span class="o">=</span> <span class="s1">&#39;error :: create_features_profile :: could not get a MySQL engine&#39;</span>
        <span class="n">current_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">fail_msg</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">context</span> <span class="o">==</span> <span class="s1">&#39;training&#39;</span> <span class="ow">or</span> <span class="n">context</span> <span class="o">==</span> <span class="s1">&#39;features_profile&#39;</span><span class="p">:</span>
            <span class="c1"># Raise to webbapp I believe to provide traceback to user in UI</span>
            <span class="k">raise</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">fail_msg</span><span class="p">,</span> <span class="n">trace</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">engine</span><span class="p">:</span>
        <span class="n">trace</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span>
        <span class="n">fail_msg</span> <span class="o">=</span> <span class="s1">&#39;error :: create_features_profile :: engine not obtained&#39;</span>
        <span class="n">current_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">fail_msg</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">context</span> <span class="o">==</span> <span class="s1">&#39;training&#39;</span> <span class="ow">or</span> <span class="n">context</span> <span class="o">==</span> <span class="s1">&#39;features_profile&#39;</span><span class="p">:</span>
            <span class="c1"># Raise to webbapp I believe to provide traceback to user in UI</span>
            <span class="k">raise</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">fail_msg</span><span class="p">,</span> <span class="n">trace</span>

    <span class="c1"># Get metric details from the database</span>
    <span class="n">metrics_id</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># Use the learn details as per config</span>
    <span class="n">metric_learn_full_duration_days</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">use_full_duration_days</span><span class="p">)</span>
    <span class="n">metric_learn_valid_ts_older_than</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">valid_learning_duration</span><span class="p">)</span>
    <span class="n">metric_max_generations</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">max_generations</span><span class="p">)</span>
    <span class="n">metric_max_percent_diff_from_origin</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">max_percent_diff_from_origin</span><span class="p">)</span>

    <span class="n">metrics_table</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">metrics_table</span><span class="p">,</span> <span class="n">fail_msg</span><span class="p">,</span> <span class="n">trace</span> <span class="o">=</span> <span class="n">metrics_table_meta</span><span class="p">(</span><span class="n">current_skyline_app</span><span class="p">,</span> <span class="n">engine</span><span class="p">)</span>
        <span class="n">current_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">fail_msg</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
        <span class="n">current_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">trace</span><span class="p">)</span>
        <span class="n">fail_msg</span> <span class="o">=</span> <span class="s1">&#39;error :: create_features_profile :: failed to get metrics_table meta for </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">base_name</span>
        <span class="n">current_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">fail_msg</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">context</span> <span class="o">==</span> <span class="s1">&#39;training&#39;</span> <span class="ow">or</span> <span class="n">context</span> <span class="o">==</span> <span class="s1">&#39;features_profile&#39;</span><span class="p">:</span>
            <span class="c1"># @added 20170806 - Bug #2130: MySQL - Aborted_clients</span>
            <span class="c1"># Added missing disposal</span>
            <span class="k">if</span> <span class="n">engine</span><span class="p">:</span>
                <span class="n">fp_create_engine_disposal</span><span class="p">(</span><span class="n">current_skyline_app</span><span class="p">,</span> <span class="n">engine</span><span class="p">)</span>
            <span class="c1"># Raise to webbapp I believe to provide traceback to user in UI</span>
            <span class="k">raise</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">current_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;create_features_profile :: disposing of any engine&#39;</span><span class="p">)</span>
            <span class="n">fp_create_engine_disposal</span><span class="p">(</span><span class="n">current_skyline_app</span><span class="p">,</span> <span class="n">engine</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">fail_msg</span><span class="p">,</span> <span class="n">trace</span>

    <span class="n">current_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;create_features_profile :: metrics_table OK&#39;</span><span class="p">)</span>

    <span class="n">metric_db_object</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">connection</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
        <span class="c1"># @modified 20161209 -  - Branch #922: ionosphere</span>
        <span class="c1">#                        Task #1658: Patterning Skyline Ionosphere</span>
        <span class="c1"># result = connection.execute(&#39;select id from metrics where metric=\&#39;%s\&#39;&#39; % base_name)</span>
<span class="c1">#        for row in result:</span>
<span class="c1">#            while not metrics_id:</span>
<span class="c1">#                metrics_id = row[&#39;id&#39;]</span>
        <span class="n">stmt</span> <span class="o">=</span> <span class="n">select</span><span class="p">([</span><span class="n">metrics_table</span><span class="p">])</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">metrics_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">metric</span> <span class="o">==</span> <span class="n">base_name</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">stmt</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
            <span class="n">metrics_id</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>
            <span class="c1"># @added 20170113 - Feature #1854: Ionosphere learn - generations</span>
            <span class="c1"># Added Ionosphere LEARN generation related variables</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">metric_learn_full_duration_days</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;learn_full_duration_days&#39;</span><span class="p">])</span>
                <span class="n">metric_learn_valid_ts_older_than</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;learn_valid_ts_older_than&#39;</span><span class="p">])</span>
                <span class="n">metric_max_generations</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;max_generations&#39;</span><span class="p">])</span>
                <span class="n">metric_max_percent_diff_from_origin</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;max_percent_diff_from_origin&#39;</span><span class="p">])</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">current_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: create_features_profile :: failed to determine learn related values from DB for </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">base_name</span><span class="p">)</span>
        <span class="n">row</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
        <span class="c1"># metric_db_object = row</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">current_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;create_features_profile :: determined db metric id: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">metrics_id</span><span class="p">))</span>
        <span class="n">current_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;create_features_profile :: determined db metric learn_full_duration_days: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_learn_full_duration_days</span><span class="p">))</span>
        <span class="n">current_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;create_features_profile :: determined db metric learn_valid_ts_older_than: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_learn_valid_ts_older_than</span><span class="p">))</span>
        <span class="n">current_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;create_features_profile :: determined db metric max_generations: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_max_generations</span><span class="p">))</span>
        <span class="n">current_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;create_features_profile :: determined db metric max_percent_diff_from_origin: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_max_percent_diff_from_origin</span><span class="p">))</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
        <span class="n">current_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">trace</span><span class="p">)</span>
        <span class="n">fail_msg</span> <span class="o">=</span> <span class="s1">&#39;error :: create_features_profile :: could not determine id of metric from DB: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">base_name</span>
        <span class="n">current_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">fail_msg</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">metric_learn_full_duration_days</span><span class="p">:</span>
        <span class="n">learn_full_duration_days</span> <span class="o">=</span> <span class="n">metric_learn_full_duration_days</span>
        <span class="c1"># learn_full_duration = int(learn_full_duration_days) * 86400</span>
    <span class="k">if</span> <span class="n">metric_learn_valid_ts_older_than</span><span class="p">:</span>
        <span class="n">learn_valid_ts_older_than</span> <span class="o">=</span> <span class="n">metric_learn_valid_ts_older_than</span>
    <span class="k">if</span> <span class="n">metric_max_generations</span><span class="p">:</span>
        <span class="n">max_generations</span> <span class="o">=</span> <span class="n">metric_max_generations</span>
    <span class="k">if</span> <span class="n">metric_max_percent_diff_from_origin</span><span class="p">:</span>
        <span class="n">max_percent_diff_from_origin</span> <span class="o">=</span> <span class="n">metric_max_percent_diff_from_origin</span>
    <span class="n">current_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;create_features_profile :: generation info - learn_full_duration_days     :: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">learn_full_duration_days</span><span class="p">)))</span>
    <span class="n">current_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;create_features_profile :: generation info - learn_valid_ts_older_than    :: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">learn_valid_ts_older_than</span><span class="p">)))</span>
    <span class="n">current_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;create_features_profile :: generation info - max_generations              :: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">max_generations</span><span class="p">)))</span>
    <span class="n">current_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;create_features_profile :: generation info - max_percent_diff_from_origin :: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">max_percent_diff_from_origin</span><span class="p">)))</span>

    <span class="c1"># @added 20170120 - Feature #1854: Ionosphere learn</span>
    <span class="c1"># Always use the timestamp from the anomaly file</span>
    <span class="n">use_anomaly_timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">requested_timestamp</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">context</span> <span class="o">==</span> <span class="s1">&#39;ionosphere_learn&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">anomaly_check_file</span><span class="p">):</span>
            <span class="n">current_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;create_features_profile :: determining the full duration from anomaly_check_file - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">anomaly_check_file</span><span class="p">)</span>
            <span class="c1"># Read the details file</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">anomaly_check_file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">anomaly_details</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">anomaly_details</span><span class="p">):</span>
                    <span class="k">if</span> <span class="s1">&#39;metric_timestamp&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                        <span class="n">_metric_timestamp</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">line</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
                        <span class="n">metric_timestamp_array</span> <span class="o">=</span> <span class="n">literal_eval</span><span class="p">(</span><span class="n">_metric_timestamp</span><span class="p">)</span>
                        <span class="n">use_anomaly_timestamp</span> <span class="o">=</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">metric_timestamp_array</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
                        <span class="n">current_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;create_features_profile :: determined the anomaly metric_timestamp as - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">use_anomaly_timestamp</span><span class="p">))</span>

    <span class="n">ionosphere_table</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">ionosphere_table</span><span class="p">,</span> <span class="n">fail_msg</span><span class="p">,</span> <span class="n">trace</span> <span class="o">=</span> <span class="n">ionosphere_table_meta</span><span class="p">(</span><span class="n">current_skyline_app</span><span class="p">,</span> <span class="n">engine</span><span class="p">)</span>
        <span class="n">current_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">fail_msg</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
        <span class="n">current_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">trace</span><span class="p">)</span>
        <span class="n">fail_msg</span> <span class="o">=</span> <span class="s1">&#39;error :: create_features_profile :: failed to get ionosphere_table meta for </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">base_name</span>
        <span class="n">current_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">fail_msg</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">context</span> <span class="o">==</span> <span class="s1">&#39;training&#39;</span> <span class="ow">or</span> <span class="n">context</span> <span class="o">==</span> <span class="s1">&#39;features_profile&#39;</span><span class="p">:</span>
            <span class="c1"># Raise to webbapp I believe to provide traceback to user in UI</span>
            <span class="c1"># @added 20170806 - Bug #2130: MySQL - Aborted_clients</span>
            <span class="c1"># Added missing disposal</span>
            <span class="k">if</span> <span class="n">engine</span><span class="p">:</span>
                <span class="n">fp_create_engine_disposal</span><span class="p">(</span><span class="n">current_skyline_app</span><span class="p">,</span> <span class="n">engine</span><span class="p">)</span>
            <span class="k">raise</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">current_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;create_features_profile :: disposing of any engine&#39;</span><span class="p">)</span>
            <span class="n">fp_create_engine_disposal</span><span class="p">(</span><span class="n">current_skyline_app</span><span class="p">,</span> <span class="n">engine</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">fail_msg</span><span class="p">,</span> <span class="n">trace</span>

    <span class="n">current_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;create_features_profile :: ionosphere_table OK&#39;</span><span class="p">)</span>

    <span class="c1"># @added 20170403 - Feature #2000: Ionosphere - validated</span>
    <span class="c1"># Set all learn_fp_human features profiles to validated.</span>
    <span class="n">fp_validated</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">ionosphere_job</span> <span class="o">==</span> <span class="s1">&#39;learn_fp_human&#39;</span><span class="p">:</span>
        <span class="n">fp_validated</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="c1"># @added 20170424 - Feature #2000: Ionosphere - validated</span>
    <span class="c1"># Set all generation 0 and 1 as validated</span>
    <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">fp_generation</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">fp_validated</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="n">new_fp_id</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">connection</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
        <span class="c1"># @added 20170113 - Feature #1854: Ionosphere learn</span>
        <span class="c1"># Added learn values parent_id, generation</span>
        <span class="c1"># @modified 20170120 - Feature #1854: Ionosphere learn</span>
        <span class="c1"># Added anomaly_timestamp</span>
        <span class="c1"># @modified 20170403 - Feature #2000: Ionosphere - validated</span>
        <span class="n">ins</span> <span class="o">=</span> <span class="n">ionosphere_table</span><span class="o">.</span><span class="n">insert</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">(</span>
            <span class="n">metric_id</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">metrics_id</span><span class="p">),</span> <span class="n">full_duration</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">ts_full_duration</span><span class="p">),</span>
            <span class="n">anomaly_timestamp</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">use_anomaly_timestamp</span><span class="p">),</span>
            <span class="n">enabled</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">tsfresh_version</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">tsfresh_version</span><span class="p">),</span>
            <span class="n">calc_time</span><span class="o">=</span><span class="n">calculated_time</span><span class="p">,</span> <span class="n">features_count</span><span class="o">=</span><span class="n">fcount</span><span class="p">,</span>
            <span class="n">features_sum</span><span class="o">=</span><span class="n">fsum</span><span class="p">,</span> <span class="n">parent_id</span><span class="o">=</span><span class="n">fp_parent_id</span><span class="p">,</span>
            <span class="n">generation</span><span class="o">=</span><span class="n">fp_generation</span><span class="p">,</span> <span class="n">validated</span><span class="o">=</span><span class="n">fp_validated</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">ins</span><span class="p">)</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">new_fp_id</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">inserted_primary_key</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">current_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;create_features_profile :: new ionosphere fp_id: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">new_fp_id</span><span class="p">))</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
        <span class="n">current_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">trace</span><span class="p">)</span>
        <span class="n">fail_msg</span> <span class="o">=</span> <span class="s1">&#39;error :: create_features_profile :: failed to insert a new record into the ionosphere table for </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">base_name</span>
        <span class="n">current_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">fail_msg</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">context</span> <span class="o">==</span> <span class="s1">&#39;training&#39;</span> <span class="ow">or</span> <span class="n">context</span> <span class="o">==</span> <span class="s1">&#39;features_profile&#39;</span><span class="p">:</span>
            <span class="c1"># @added 20170806 - Bug #2130: MySQL - Aborted_clients</span>
            <span class="c1"># Added missing disposal</span>
            <span class="k">if</span> <span class="n">engine</span><span class="p">:</span>
                <span class="n">fp_create_engine_disposal</span><span class="p">(</span><span class="n">current_skyline_app</span><span class="p">,</span> <span class="n">engine</span><span class="p">)</span>
            <span class="c1"># Raise to webbapp I believe to provide traceback to user in UI</span>
            <span class="k">raise</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">current_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;create_features_profile :: disposing of any engine&#39;</span><span class="p">)</span>
            <span class="n">fp_create_engine_disposal</span><span class="p">(</span><span class="n">current_skyline_app</span><span class="p">,</span> <span class="n">engine</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">fail_msg</span><span class="p">,</span> <span class="n">trace</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">RepresentsInt</span><span class="p">(</span><span class="n">new_fp_id</span><span class="p">):</span>
        <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
        <span class="n">current_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">trace</span><span class="p">)</span>
        <span class="n">fail_msg</span> <span class="o">=</span> <span class="s1">&#39;error :: create_features_profile :: unknown new ionosphere new_fp_id for </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">base_name</span>
        <span class="n">current_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">fail_msg</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">context</span> <span class="o">==</span> <span class="s1">&#39;training&#39;</span> <span class="ow">or</span> <span class="n">context</span> <span class="o">==</span> <span class="s1">&#39;features_profile&#39;</span><span class="p">:</span>
            <span class="c1"># @added 20170806 - Bug #2130: MySQL - Aborted_clients</span>
            <span class="c1"># Added missing disposal</span>
            <span class="k">if</span> <span class="n">engine</span><span class="p">:</span>
                <span class="n">fp_create_engine_disposal</span><span class="p">(</span><span class="n">current_skyline_app</span><span class="p">,</span> <span class="n">engine</span><span class="p">)</span>
            <span class="c1"># Raise to webbapp I believe to provide traceback to user in UI</span>
            <span class="k">raise</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">current_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;create_features_profile :: disposing of any engine&#39;</span><span class="p">)</span>
            <span class="n">fp_create_engine_disposal</span><span class="p">(</span><span class="n">current_skyline_app</span><span class="p">,</span> <span class="n">engine</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">fail_msg</span><span class="p">,</span> <span class="n">trace</span>

    <span class="c1"># Create z_fp_&lt;metric_id&gt; table</span>
    <span class="n">fp_table_created</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">fp_table_name</span> <span class="o">=</span> <span class="s1">&#39;z_fp_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">metrics_id</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">fp_meta</span> <span class="o">=</span> <span class="n">MetaData</span><span class="p">()</span>
        <span class="c1"># @modified 20161222 - Task #1812: z_fp table type</span>
        <span class="c1"># Changed to InnoDB from MyISAM as no files open issues and MyISAM clean</span>
        <span class="c1"># up, there can be LOTS of file_per_table z_fp_ tables/files without</span>
        <span class="c1"># the MyISAM issues.  z_fp_ tables are mostly read and will be shuffled</span>
        <span class="c1"># in the table cache as required.</span>
        <span class="n">fp_metric_table</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span>
            <span class="n">fp_table_name</span><span class="p">,</span> <span class="n">fp_meta</span><span class="p">,</span>
            <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
            <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;fp_id&#39;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;fp_id&#39;</span><span class="p">),</span>
            <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;feature_id&#39;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
            <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="n">DOUBLE</span><span class="p">(),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
            <span class="n">mysql_charset</span><span class="o">=</span><span class="s1">&#39;utf8&#39;</span><span class="p">,</span>
            <span class="n">mysql_key_block_size</span><span class="o">=</span><span class="s1">&#39;255&#39;</span><span class="p">,</span>
            <span class="n">mysql_engine</span><span class="o">=</span><span class="s1">&#39;InnoDB&#39;</span><span class="p">)</span>
        <span class="n">fp_metric_table</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="n">checkfirst</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">fp_table_created</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
        <span class="n">current_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">trace</span><span class="p">)</span>
        <span class="n">fail_msg</span> <span class="o">=</span> <span class="s1">&#39;error :: create_features_profile :: failed to create table - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">fp_table_name</span>
        <span class="n">current_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">fail_msg</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">context</span> <span class="o">==</span> <span class="s1">&#39;training&#39;</span> <span class="ow">or</span> <span class="n">context</span> <span class="o">==</span> <span class="s1">&#39;features_profile&#39;</span><span class="p">:</span>
            <span class="c1"># @added 20170806 - Bug #2130: MySQL - Aborted_clients</span>
            <span class="c1"># Added missing disposal</span>
            <span class="k">if</span> <span class="n">engine</span><span class="p">:</span>
                <span class="n">fp_create_engine_disposal</span><span class="p">(</span><span class="n">current_skyline_app</span><span class="p">,</span> <span class="n">engine</span><span class="p">)</span>
            <span class="c1"># Raise to webbapp I believe to provide traceback to user in UI</span>
            <span class="k">raise</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">current_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;create_features_profile :: </span><span class="si">%s</span><span class="s1"> - automated so the table should exists continuing&#39;</span> <span class="o">%</span> <span class="n">context</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">fp_table_created</span><span class="p">:</span>
        <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
        <span class="n">current_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">trace</span><span class="p">)</span>
        <span class="n">fail_msg</span> <span class="o">=</span> <span class="s1">&#39;error :: create_features_profile :: failed to determine True for create table - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">fp_table_name</span>
        <span class="n">current_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">fail_msg</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">context</span> <span class="o">==</span> <span class="s1">&#39;training&#39;</span> <span class="ow">or</span> <span class="n">context</span> <span class="o">==</span> <span class="s1">&#39;features_profile&#39;</span><span class="p">:</span>
            <span class="c1"># @added 20170806 - Bug #2130: MySQL - Aborted_clients</span>
            <span class="c1"># Added missing disposal</span>
            <span class="k">if</span> <span class="n">engine</span><span class="p">:</span>
                <span class="n">fp_create_engine_disposal</span><span class="p">(</span><span class="n">current_skyline_app</span><span class="p">,</span> <span class="n">engine</span><span class="p">)</span>
            <span class="c1"># Raise to webbapp I believe to provide traceback to user in UI</span>
            <span class="k">raise</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">current_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;create_features_profile :: </span><span class="si">%s</span><span class="s1"> - automated so the table should exists continuing&#39;</span> <span class="o">%</span> <span class="n">context</span><span class="p">)</span>

    <span class="c1"># Insert features and values</span>
    <span class="n">insert_statement</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">fname_id</span><span class="p">,</span> <span class="n">f_value</span> <span class="ow">in</span> <span class="n">features_data</span><span class="p">:</span>
        <span class="n">insert_statement</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;fp_id&#39;</span><span class="p">:</span> <span class="n">new_fp_id</span><span class="p">,</span> <span class="s1">&#39;feature_id&#39;</span><span class="p">:</span> <span class="n">fname_id</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">f_value</span><span class="p">},)</span>
    <span class="k">if</span> <span class="n">insert_statement</span> <span class="o">==</span> <span class="p">[]:</span>
        <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
        <span class="n">current_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">trace</span><span class="p">)</span>
        <span class="n">fail_msg</span> <span class="o">=</span> <span class="s1">&#39;error :: create_features_profile :: empty insert_statement for </span><span class="si">%s</span><span class="s1"> inserts&#39;</span> <span class="o">%</span> <span class="n">fp_table_name</span>
        <span class="n">current_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">fail_msg</span><span class="p">)</span>
        <span class="c1"># raise</span>
    <span class="c1"># else:</span>
        <span class="c1"># feature_count = sum(1 for x in a if isinstance(x, insert_statement))</span>
        <span class="c1"># current_logger.info(</span>
        <span class="c1">#     &#39;fp_id - %s - %s feature values in insert_statement for %s &#39; %</span>
        <span class="c1">#     (str(feature_count), str(new_fp_id), fp_table_name))</span>
        <span class="c1"># feature_count = sum(1 for x in a if isinstance(x, insert_statement))</span>
        <span class="c1"># current_logger.info(</span>
        <span class="c1">#     &#39;fp_id - %s - feature values in insert_statement for %s &#39; %</span>
        <span class="c1">#     (str(new_fp_id), fp_table_name))</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">connection</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">fp_metric_table</span><span class="o">.</span><span class="n">insert</span><span class="p">(),</span> <span class="n">insert_statement</span><span class="p">)</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">current_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;create_features_profile :: fp_id - </span><span class="si">%s</span><span class="s1"> - feature values inserted into </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">new_fp_id</span><span class="p">),</span> <span class="n">fp_table_name</span><span class="p">))</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
        <span class="n">current_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">trace</span><span class="p">)</span>
        <span class="n">fail_msg</span> <span class="o">=</span> <span class="s1">&#39;error :: create_features_profile :: failed to insert a feature values into </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">fp_table_name</span>
        <span class="n">current_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">fail_msg</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">context</span> <span class="o">==</span> <span class="s1">&#39;training&#39;</span> <span class="ow">or</span> <span class="n">context</span> <span class="o">==</span> <span class="s1">&#39;features_profile&#39;</span><span class="p">:</span>
            <span class="c1"># @added 20170806 - Bug #2130: MySQL - Aborted_clients</span>
            <span class="c1"># Added missing disposal</span>
            <span class="k">if</span> <span class="n">engine</span><span class="p">:</span>
                <span class="n">fp_create_engine_disposal</span><span class="p">(</span><span class="n">current_skyline_app</span><span class="p">,</span> <span class="n">engine</span><span class="p">)</span>
            <span class="c1"># Raise to webbapp I believe to provide traceback to user in UI</span>
            <span class="k">raise</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">current_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;create_features_profile :: </span><span class="si">%s</span><span class="s1"> - automated so the table should exists continuing&#39;</span> <span class="o">%</span> <span class="n">context</span><span class="p">)</span>

    <span class="c1"># Create metric ts table if not exists ts_&lt;metric_id&gt;</span>
    <span class="c1"># Create z_ts_&lt;metric_id&gt; table</span>
    <span class="c1"># @modified 20170121 - Feature #1854: Ionosphere learn - generations</span>
    <span class="c1"># TODO Adding the option to not save timeseries to DB, as default?</span>
    <span class="c1"># ts_table_created = False</span>
    <span class="n">ts_table_name</span> <span class="o">=</span> <span class="s1">&#39;z_ts_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">metrics_id</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">ts_meta</span> <span class="o">=</span> <span class="n">MetaData</span><span class="p">()</span>
        <span class="c1"># @modified 20161222 - Task #1812: z_fp table type</span>
        <span class="c1"># Changed to InnoDB from MyISAM as no files open issues and MyISAM clean</span>
        <span class="c1"># up, there can be LOTS of file_per_table z_fp_ tables/files without</span>
        <span class="c1"># the MyISAM issues.  z_fp_ tables are mostly read and will be shuffled</span>
        <span class="c1"># in the table cache as required.</span>
        <span class="n">ts_metric_table</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span>
            <span class="n">ts_table_name</span><span class="p">,</span> <span class="n">ts_meta</span><span class="p">,</span>
            <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
            <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;fp_id&#39;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;fp_id&#39;</span><span class="p">),</span>
            <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;timestamp&#39;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
            <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="n">DOUBLE</span><span class="p">(),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
            <span class="n">mysql_charset</span><span class="o">=</span><span class="s1">&#39;utf8&#39;</span><span class="p">,</span>
            <span class="n">mysql_key_block_size</span><span class="o">=</span><span class="s1">&#39;255&#39;</span><span class="p">,</span>
            <span class="n">mysql_engine</span><span class="o">=</span><span class="s1">&#39;InnoDB&#39;</span><span class="p">)</span>
        <span class="n">ts_metric_table</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="n">checkfirst</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># ts_table_created = True</span>
        <span class="n">current_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;create_features_profile :: metric ts table created OK - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ts_table_name</span><span class="p">))</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
        <span class="n">current_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">trace</span><span class="p">)</span>
        <span class="n">fail_msg</span> <span class="o">=</span> <span class="s1">&#39;error :: create_features_profile :: failed to create table - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">ts_table_name</span>
        <span class="n">current_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">fail_msg</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">context</span> <span class="o">==</span> <span class="s1">&#39;training&#39;</span> <span class="ow">or</span> <span class="n">context</span> <span class="o">==</span> <span class="s1">&#39;features_profile&#39;</span><span class="p">:</span>
            <span class="c1"># @added 20170806 - Bug #2130: MySQL - Aborted_clients</span>
            <span class="c1"># Added missing disposal</span>
            <span class="k">if</span> <span class="n">engine</span><span class="p">:</span>
                <span class="n">fp_create_engine_disposal</span><span class="p">(</span><span class="n">current_skyline_app</span><span class="p">,</span> <span class="n">engine</span><span class="p">)</span>
            <span class="c1"># Raise to webbapp I believe to provide traceback to user in UI</span>
            <span class="k">raise</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">current_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;create_features_profile :: </span><span class="si">%s</span><span class="s1"> - automated so the table should exists continuing&#39;</span> <span class="o">%</span> <span class="n">context</span><span class="p">)</span>

    <span class="c1"># Insert timeseries that the features profile was created from</span>
    <span class="n">raw_timeseries</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">anomaly_json</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">.json&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">metric_training_data_dir</span><span class="p">,</span> <span class="n">base_name</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">anomaly_json</span><span class="p">):</span>
        <span class="n">current_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;create_features_profile :: metric anomaly json found OK - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">anomaly_json</span><span class="p">))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Read the timeseries json file</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">anomaly_json</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">raw_timeseries</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
            <span class="n">current_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">trace</span><span class="p">)</span>
            <span class="n">fail_msg</span> <span class="o">=</span> <span class="s1">&#39;error :: create_features_profile :: failed to read timeseries data from </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">anomaly_json</span>
            <span class="n">current_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fail_msg</span><span class="p">))</span>
            <span class="n">fail_msg</span> <span class="o">=</span> <span class="s1">&#39;error: failed to read timeseries data from </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">anomaly_json</span>
            <span class="c1"># end = timer()</span>
            <span class="k">if</span> <span class="n">context</span> <span class="o">==</span> <span class="s1">&#39;training&#39;</span> <span class="ow">or</span> <span class="n">context</span> <span class="o">==</span> <span class="s1">&#39;features_profile&#39;</span><span class="p">:</span>
                <span class="c1"># @added 20170806 - Bug #2130: MySQL - Aborted_clients</span>
                <span class="c1"># Added missing disposal</span>
                <span class="k">if</span> <span class="n">engine</span><span class="p">:</span>
                    <span class="n">fp_create_engine_disposal</span><span class="p">(</span><span class="n">current_skyline_app</span><span class="p">,</span> <span class="n">engine</span><span class="p">)</span>
                <span class="c1"># Raise to webbapp I believe to provide traceback to user in UI</span>
                <span class="k">raise</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">trace</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span>
        <span class="n">fail_msg</span> <span class="o">=</span> <span class="s1">&#39;error: file not found - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">anomaly_json</span><span class="p">)</span>
        <span class="n">current_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">fail_msg</span><span class="p">)</span>
        <span class="c1"># raise</span>

    <span class="c1"># Convert the timeseries to csv</span>
    <span class="n">timeseries_array_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">raw_timeseries</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;(&#39;</span><span class="p">,</span> <span class="s1">&#39;[&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;)&#39;</span><span class="p">,</span> <span class="s1">&#39;]&#39;</span><span class="p">)</span>
    <span class="n">timeseries</span> <span class="o">=</span> <span class="n">literal_eval</span><span class="p">(</span><span class="n">timeseries_array_str</span><span class="p">)</span>

    <span class="n">datapoints</span> <span class="o">=</span> <span class="n">timeseries</span>
    <span class="n">validated_timeseries</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">datapoint</span> <span class="ow">in</span> <span class="n">datapoints</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">new_datapoint</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">datapoint</span><span class="p">[</span><span class="mi">0</span><span class="p">])),</span> <span class="nb">float</span><span class="p">(</span><span class="n">datapoint</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>
            <span class="n">validated_timeseries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_datapoint</span><span class="p">)</span>
        <span class="c1"># @modified 20170913 - Task #2160: Test skyline with bandit</span>
        <span class="c1"># Added nosec to exclude from bandit tests</span>
        <span class="k">except</span><span class="p">:</span>  <span class="c1"># nosec</span>
            <span class="k">continue</span>

    <span class="n">insert_statement</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">ts</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">validated_timeseries</span><span class="p">:</span>
        <span class="n">insert_statement</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;fp_id&#39;</span><span class="p">:</span> <span class="n">new_fp_id</span><span class="p">,</span> <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">ts</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">value</span><span class="p">},)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">connection</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">ts_metric_table</span><span class="o">.</span><span class="n">insert</span><span class="p">(),</span> <span class="n">insert_statement</span><span class="p">)</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">current_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;create_features_profile :: fp_id - </span><span class="si">%s</span><span class="s1"> - timeseries inserted into </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">new_fp_id</span><span class="p">),</span> <span class="n">ts_table_name</span><span class="p">))</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
        <span class="n">current_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">trace</span><span class="p">)</span>
        <span class="n">fail_msg</span> <span class="o">=</span> <span class="s1">&#39;error :: create_features_profile :: failed to insert the timeseries into </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">ts_table_name</span>
        <span class="n">current_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">fail_msg</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">context</span> <span class="o">==</span> <span class="s1">&#39;training&#39;</span> <span class="ow">or</span> <span class="n">context</span> <span class="o">==</span> <span class="s1">&#39;features_profile&#39;</span><span class="p">:</span>
            <span class="c1"># @added 20170806 - Bug #2130: MySQL - Aborted_clients</span>
            <span class="c1"># Added missing disposal</span>
            <span class="k">if</span> <span class="n">engine</span><span class="p">:</span>
                <span class="n">fp_create_engine_disposal</span><span class="p">(</span><span class="n">current_skyline_app</span><span class="p">,</span> <span class="n">engine</span><span class="p">)</span>
            <span class="k">raise</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">current_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;create_features_profile :: </span><span class="si">%s</span><span class="s1"> - automated so the table should exists continuing&#39;</span> <span class="o">%</span> <span class="n">context</span><span class="p">)</span>

    <span class="c1"># Create a created features profile file</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># data = &#39;[%s, %s, ]&#39; % (new_fp_id, str(int(time.time())))</span>
        <span class="c1"># write_data_to_file(skyline_app, features_profile_created_file, &#39;w&#39;, data)</span>
        <span class="c1"># @modified 20170115 -  Feature #1854: Ionosphere learn - generations</span>
        <span class="c1"># Added parent_id and generation</span>
        <span class="n">data</span> <span class="o">=</span> <span class="s1">&#39;[</span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">, </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;</span><span class="s1">, </span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">]&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">new_fp_id</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())),</span> <span class="nb">str</span><span class="p">(</span><span class="n">tsfresh_version</span><span class="p">),</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">calculated_time</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">fcount</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">fsum</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">ts_full_duration</span><span class="p">),</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">fp_parent_id</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">fp_generation</span><span class="p">))</span>
        <span class="n">write_data_to_file</span><span class="p">(</span><span class="n">current_skyline_app</span><span class="p">,</span> <span class="n">features_profile_created_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
        <span class="n">current_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">trace</span><span class="p">)</span>
        <span class="n">fail_msg</span> <span class="o">=</span> <span class="s1">&#39;error :: create_features_profile :: failed to write fp.created file&#39;</span>
        <span class="n">current_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">fail_msg</span><span class="p">)</span>

    <span class="c1"># Set ionosphere_enabled for the metric</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># update_statement = &#39;UPDATE metrics SET ionosphere_enabled=1 WHERE id=%s&#39; % str(metrics_id)</span>
        <span class="n">connection</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
        <span class="c1"># result = connection.execute(&#39;UPDATE metrics SET ionosphere_enabled=1 WHERE id=%s&#39; % str(metrics_id))</span>
        <span class="c1"># connection.execute(ts_metric_table.insert(), insert_statement)</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="n">metrics_table</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                <span class="n">metrics_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">metrics_id</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="n">ionosphere_enabled</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">current_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;create_features_profile :: ionosphere_enabled set on metric id: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">metrics_id</span><span class="p">))</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
        <span class="n">current_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">trace</span><span class="p">)</span>
        <span class="n">fail_msg</span> <span class="o">=</span> <span class="s1">&#39;error :: create_features_profile :: could not update metrics table and set ionosphere_enabled on id </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">metrics_id</span><span class="p">)</span>
        <span class="n">current_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">fail_msg</span><span class="p">)</span>
        <span class="c1"># raise</span>

    <span class="c1"># Copy data from training data dir to features_profiles dir</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">ts_features_profile_dir</span><span class="p">):</span>
        <span class="n">mkdir_p</span><span class="p">(</span><span class="n">ts_features_profile_dir</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">ts_features_profile_dir</span><span class="p">):</span>
        <span class="n">current_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;create_features_profile :: fp_id - </span><span class="si">%s</span><span class="s1"> - features profile dir created - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">new_fp_id</span><span class="p">),</span> <span class="n">ts_features_profile_dir</span><span class="p">))</span>
        <span class="c1"># src_files = os.listdir(src)</span>
        <span class="c1"># for file_name in src_files:</span>
        <span class="c1">#    full_file_name = path.join(src, file_name)</span>
        <span class="c1">#    if (path.isfile(full_file_name)):</span>
        <span class="c1">#        shutil.copy(full_file_name, dest)</span>

        <span class="n">data_files</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">glob_path</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/*.*&#39;</span> <span class="o">%</span> <span class="n">metric_training_data_dir</span>
            <span class="n">data_files</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">glob_path</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
            <span class="n">current_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">trace</span><span class="p">)</span>
            <span class="n">current_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: create_features_profile :: glob - fp_id - </span><span class="si">%s</span><span class="s1"> - training data not copied to </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">new_fp_id</span><span class="p">),</span> <span class="n">ts_features_profile_dir</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">i_file</span> <span class="ow">in</span> <span class="n">data_files</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">i_file</span><span class="p">,</span> <span class="n">ts_features_profile_dir</span><span class="p">)</span>
                <span class="n">current_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;create_features_profile :: fp_id - </span><span class="si">%s</span><span class="s1"> - training data copied - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">new_fp_id</span><span class="p">),</span> <span class="n">i_file</span><span class="p">))</span>
            <span class="k">except</span> <span class="n">shutil</span><span class="o">.</span><span class="n">Error</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
                <span class="n">current_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">trace</span><span class="p">)</span>
                <span class="n">current_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: create_features_profile :: shutil error - fp_id - </span><span class="si">%s</span><span class="s1"> - training data not copied to </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">new_fp_id</span><span class="p">),</span> <span class="n">ts_features_profile_dir</span><span class="p">))</span>
                <span class="n">current_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: create_features_profile :: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">e</span><span class="p">))</span>
            <span class="c1"># Any error saying that the directory doesn&#39;t exist</span>
            <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
                <span class="n">current_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">trace</span><span class="p">)</span>
                <span class="n">current_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: create_features_profile :: OSError error - fp_id - </span><span class="si">%s</span><span class="s1"> - training data not copied to </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">new_fp_id</span><span class="p">),</span> <span class="n">ts_features_profile_dir</span><span class="p">))</span>
                <span class="n">current_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: create_features_profile :: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">e</span><span class="p">))</span>
        <span class="n">current_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;create_features_profile :: fp_id - </span><span class="si">%s</span><span class="s1"> - training data copied to </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">new_fp_id</span><span class="p">),</span> <span class="n">ts_features_profile_dir</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">current_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: create_features_profile :: fp_id - </span><span class="si">%s</span><span class="s1"> - training data not copied to </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">new_fp_id</span><span class="p">),</span> <span class="n">ts_features_profile_dir</span><span class="p">))</span>

    <span class="n">current_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;create_features_profile :: disposing of any engine&#39;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">engine</span><span class="p">:</span>
            <span class="n">fp_create_engine_disposal</span><span class="p">(</span><span class="n">current_skyline_app</span><span class="p">,</span> <span class="n">engine</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">current_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;create_features_profile :: no engine to dispose of&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">new_fp_id</span><span class="p">),</span> <span class="n">ts_features_profile_dir</span><span class="p">))</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
        <span class="n">current_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">trace</span><span class="p">)</span>
        <span class="n">current_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: create_features_profile :: OSError error - fp_id - </span><span class="si">%s</span><span class="s1"> - training data not copied to </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">new_fp_id</span><span class="p">),</span> <span class="n">ts_features_profile_dir</span><span class="p">))</span>

    <span class="c1"># @added 20170113 - Feature #1854: Ionosphere learn - Redis ionosphere.learn.work namespace</span>
    <span class="c1"># Ionosphere learn needs Redis works sets</span>
    <span class="c1"># When a features profile is created there needs to be work added to a Redis</span>
    <span class="c1"># set. When a human makes a features profile, we want Ionosphere to make a</span>
    <span class="c1"># use_full_duration_days features profile valid_learning_duration (e.g.</span>
    <span class="c1"># 3361) later.</span>
    <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">IONOSPHERE_LEARN</span> <span class="ow">and</span> <span class="n">new_fp_id</span><span class="p">:</span>
        <span class="n">create_redis_work_item</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">context</span> <span class="o">==</span> <span class="s1">&#39;training_data&#39;</span> <span class="ow">and</span> <span class="n">ionosphere_job</span> <span class="o">==</span> <span class="s1">&#39;learn_fp_human&#39;</span><span class="p">:</span>
            <span class="n">create_redis_work_item</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="c1"># @modified 20170120 -  Feature #1854: Ionosphere learn - generations</span>
            <span class="c1"># Added fp_learn parameter to allow the user to not learn the</span>
            <span class="c1"># use_full_duration_days</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">fp_learn</span><span class="p">:</span>
                <span class="n">create_redis_work_item</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">current_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;fp_learn is False not adding an item to Redis ionosphere.learn.work set&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">ionosphere_job</span> <span class="o">==</span> <span class="s1">&#39;learn_fp_automatic&#39;</span><span class="p">:</span>
            <span class="n">create_redis_work_item</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="c1"># @added 20170131 - Feature #1886 Ionosphere learn - child like parent with evolutionary maturity</span>
            <span class="c1"># TODO: here a check may be required to evaluate whether the origin_fp_id</span>
            <span class="c1">#       had a use_full_duration features profile created, however</span>
            <span class="c1">#       due to the fact that it is in learn, suggests that it did</span>
            <span class="c1">#       have, not 100% sure.</span>
            <span class="n">origin_fp_id_was_allowed_to_learn</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">child_use_full_duration_count_of_origin_fp_id</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="c1"># TODO: Determine the state</span>
            <span class="c1"># child_use_full_duration_count_of_origin_fp_id = SELECT COUNT(id) FROM ionosphere WHERE parent_id=origin_fp_id AND full_duration=use_full_duration</span>
            <span class="k">if</span> <span class="n">child_use_full_duration_count_of_origin_fp_id</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">current_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;the origin parent was not allowed to learn not adding to Redis ionosphere.learn.work set&#39;</span><span class="p">)</span>
                <span class="n">create_redis_work_item</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">create_redis_work_item</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">current_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s1">&#39;adding work to Redis ionosphere.learn.work set - [</span><span class="se">\&#39;</span><span class="s1">Soft</span><span class="se">\&#39;</span><span class="s1">, </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;</span><span class="s1">, </span><span class="si">%s</span><span class="s1">, </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;</span><span class="s1">, </span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">] to make a learn features profile later&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">ionosphere_job</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">requested_timestamp</span><span class="p">),</span> <span class="n">base_name</span><span class="p">,</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">new_fp_id</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">fp_generation</span><span class="p">)))</span>
                <span class="n">redis_conn</span> <span class="o">=</span> <span class="n">StrictRedis</span><span class="p">(</span><span class="n">unix_socket_path</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">REDIS_SOCKET_PATH</span><span class="p">)</span>
                <span class="n">redis_conn</span><span class="o">.</span><span class="n">sadd</span><span class="p">(</span><span class="s1">&#39;ionosphere.learn.work&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;Soft&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">ionosphere_job</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">requested_timestamp</span><span class="p">),</span> <span class="n">base_name</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">new_fp_id</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">fp_generation</span><span class="p">)])</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">current_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">current_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="s1">&#39;error :: failed adding work to Redis ionosphere.learn.work set - [</span><span class="se">\&#39;</span><span class="s1">Soft</span><span class="se">\&#39;</span><span class="s1">, </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;</span><span class="s1">, </span><span class="si">%s</span><span class="s1">, </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;</span><span class="s1">, </span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">] to make a learn features profile later&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">ionosphere_job</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">requested_timestamp</span><span class="p">),</span> <span class="n">base_name</span><span class="p">,</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">new_fp_id</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">fp_generation</span><span class="p">)))</span>

        <span class="c1"># @added 20170806 - Bug #2130: MySQL - Aborted_clients</span>
        <span class="c1"># Added missing disposal</span>
        <span class="k">if</span> <span class="n">engine</span><span class="p">:</span>
            <span class="n">fp_create_engine_disposal</span><span class="p">(</span><span class="n">current_skyline_app</span><span class="p">,</span> <span class="n">engine</span><span class="p">)</span>

    <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">new_fp_id</span><span class="p">),</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">fail_msg</span><span class="p">,</span> <span class="n">trace</span></div>
</pre></div>

           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2013-2014, Etsy Inc; 2015, Abe Stanway; 2015-2017, Gary Wilson.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'1.1.7-beta',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>